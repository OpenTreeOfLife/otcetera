\documentclass[11pt]{article}
\input{preamble.tex}
\newcommand{\insed}{{\em incertae sedis}\xspace}
\newcommand{\specialHypergraph}{rooted tree-based quasi-hierarchical hypergraph \xspace}

\newcommand{\placedTaxa}{\ensuremath{\mathcal{P}}\xspace}
\newcommand{\placedTaxoTree}{\ensuremath{P}\xspace}
\newcommand{\placedTaxoTreeName}{placed-taxa tree\xspace}
\newcommand{\naiveFullTree}{\ensuremath{N}\xspace}
\newcommand{\augmentedFullTree}{\ensuremath{E}\xspace}
\newcommand{\specHyper}{\ensuremath{H}\xspace}
\newcommand{\naiveFullTreeName}{naive full taxonomic tree\xspace}
\newcommand{\insedChildren}[1]{\ensuremath{\mathcal{I}(#1)}\xspace}
\newcommand{\corresponding}[2]{\ensuremath{c_{#2}(#1)}\xspace}
\usepackage{hyperref}
\hypersetup{backref,  linkcolor=blue, citecolor=black, colorlinks=true, hyperindex=true}
\begin{document}
The source for this in the doc subdirectory of the otcetera
    repo \url{https://github.com/mtholder/otcetera/tree/master/doc}.
This will probably be merged with the summarizing-taxonomy-plus-trees.tex document at
    some point.
\begin{center}
    {\bf Handling \insed taxa in Open Tree synthesis} \\
{Mark T.~Holder$^{1,2,\ast}$. feel free to contribute and add your name}
\end{center}
\tableofcontents
\section{Background}
See \href{https://github.com/OpenTreeOfLife/germinator/issues/32}{germinator issue \#32} for more details.

The phrase ``\insed'' is used in classifications to indicate that a group is of uncertain
    taxonomic placement.
The Open Tree's reference taxonomy is produced by a tool called smasher that notices hints that a taxon
    is \insed and labels that taxon with one of five flags.\footnote{see \url{https://github.com/OpenTreeOfLife/reference-taxonomy/wiki/Taxon-flags}. This document is not
    concerned with the flagging system {\em per se}, so ``\insed'' will be used here to
    refer to all of the flags that denote taxa with uncertain placement.}
While a taxonomist may intend to use \insed to indicate a limited number of possible positions for 
    a taxon to go in the taxonomy, we do not retain any such details.


Our current pipeline for producing a tree takes a set of ranked trees with the last tree
    being the taxonomy; thus it is a true supertree analysis.
The OTT is converted to a tree by pruning off taxa based on their flags.
As of December 2, 2015, this pruning (for all versions of the synthetic tree that we have used)
    has removed \insed taxa.

\subsection{Some examples in OTT}
The problem is becoming more acute because NCBI is putting a larger number of taxa into groups that
    are marked as ``unclassified.''
For example, when OTT 2.9 was created NCBI's clasification of the bird family Sylvidae included 
    a group five genera that were placed within ``\href{http://www.ncbi.nlm.nih.gov/Taxonomy/Browser/wwwtax.cgi?mode=Undef&id=36270&lvl=3&lin=f&keep=1&srchmode=1&unlock}{unclassified Sylviidae.}''
This includes the genus {Regulus}.
Thus in OTT 2.9 Regulus (ott ID = 3599326) is placed inside the family Silvidae (OTT ID = 259942).
The ``unclassified Sylviidae'' does not appear in OTT; instead Regulus is flagged as ``unclassified,sibling\_higher''
and all of the species within Regulus are flagged as ``unclassified\_inherited.''

The taxonomy (as of version 2.9) also contains 685 cases of taxa that are flagged as both
    ``unclassified\_inherited'' and  ``unclassified''\footnote{based on {\tt grep unclass.*unclassified\_inherited taxonomy.tsv}}

We would like to stop suppressing (pruning) \insed taxa, so that groups such as Regulus can appear
    appear in the synthetic tree.

\subsection{Challenge for the supertree construction}
Leaving \insed taxa in the taxonomy, means that the taxonomy can no longer be represented as 
    a tree.
Instead it must be represented by something equivalent to a special type of hypergraph (see below)
Thus, we need to devise a new pipeline for taking a set of trees and one low-ranked hypergraph and
    producing a hypergraph.

\section{\specialHypergraph}
Let each OTT Id in the taxonomy refer to a node.
If all nodes that correspond to \insed taxa or there descendants are removed,
    then the parent referenc in OTT Id allows one to construct 
    a directed graph - in particular the resulting graph will be rooted tree (it will be connected
    and have no cycles) that represents a set of phylogenetic hypotheses  which are compatible
    with the taxonomy.
Let us denote this \placedTaxoTree and refer to is as the ``\placedTaxoTreeName''.
The set of taxa (each of which maps to an OTT ID) in this tree will be referred to as \placedTaxa.

If we include all nodes from OTT (if we do not exclude \insed) we can still produce
    a tree,  \naiveFullTree, the ``\naiveFullTreeName''.
This is naive in the sense that the taxonomy does not really make the claim that an \insed
    taxon is excluded from its sister group (or the descendants of it sister group). 
Thus any resulution of \naiveFullTree can be said to be compatible with the taxonomy, but there
    exist other trees which conflict with \naiveFullTree but which do not conflict with
    the correct interpretation of the claims of taxonomy.

Let \augmentedFullTree denote a tree that is created by taking \naiveFullTree and replacing each
    edge with a pair of edges by introducing a new node with out-degree=1.
The set of nodes introduced by this step is denoted $\mathcal{A}$.
The root of the tree will not be n $\mathcal{A}$ and the path from the root to any tip will alternate
    between nodes not in $\matccal{A}$ and nodes in $\mathcal{A}$.
This augmented tree depicts all the possible attachment points for a new edge in the tree.
Note that \naiveFullTree tree induced by \placedTaxa is homeomorphic to \placedTaxoTree.
Thus for any node $n$ in \placedTaxoTree, we can find a corresponding node 
  \corresponding{n}{\naiveFullTree} in \naiveFullTree and a corresponding node
   \corresponding{n}{\augmentedFullTree} in \augmentedFullTree.

For any internal node $n\in\mathccal{A}$ in \augmentedFullTree, let \insedChildren{n}
     denote the set of children
    of $n$ which are mapped to OTT Ids flagged as being \insed taxa; this can be the empty set.

For an internal node $n\notin\mathcal{A}$ let \insedChildren{n} denote the set of grandchildren
    of $n$ mapped to flagged taxa. This just provides handy notation for skipping over the 
    set of augmented nodes.

A hypergraph \specHyper that accurately depicts the taxonomic knowledge in OTT is one that can be produced by
    traversing $\augmentedFullTree$ and performing the following operations for each internal node $n\notin \mathcal{A}$.
If $n$ is mapped to an OTT Id that is flagged as \insed, then let $p=\parent{n}$ and $g=\parent{p}$
Note that (by construction of \augmentedFullTree) we know that 
    $p\in\mathcal{A}$ and $g\notin\mathcal{A}$.
First we cut (remove) the edge that connects a member of $p$ to $g$
    and replace that edge by introducing a directed hyperedge that connects node
    $p$ (as the child) to the set of nodes in \augmentedFullTree (as the set of parent nodes)
    such that each member of the parent node set:
\begin{compactitem}
    \item a $g$ or a descendant of $g$ in $\augmentedFullTree$, and
    \item not a descendant of $p$ in $\augmentedFullTree$
\end{compactitem}
This hypergraph conveys the fact that the \insed taxon must in the clade to which it is 
    assigned by OTT (the taxon that is mapped to $g$),
    however the \insed taxon can attach anywhere within that clade (expressing
    this full set of possible attachment points was the reason for augmenting the tree
    with $\mathcal{A}$).

We will define a \specialHypergraph as being a hypergraph such as $H$ with the key properties being:
\begin{compactitem}
    \item all edges are directed
    \item each directed hyper edge has one daughter node but (potentially large) set of parental nodes.
    \item the modifier ``tree-based'' is used because their exists a unique directed tree,
    $\augmentedFullTree$ for the graph. This is the tree that can be recovered by reversing the 
    operations described above; roughly speaking, replace each hyperedge with a normal edge that connect 
    the most rootward node in the parental node set to the child node.
    \item the hypergraph is quasi-hierarchical in the sense that, for each hyperedge, the set of parental
        nodes corresponds to all of the nodes in a subtree of $E$ with the exception of the nodes
        that are descendants of the hyper edge.
        Thus the sets of parental nodes for two distinct hyperedges almost fulfill the standard
        rules for hierarchies (that they do not overlap or one is a subset of the other).
        The only exceptions to this are two hyperedges that are created as the result of two 
        \insed taxa that are sister groups in \naiveFullTree.
\end{compactitem}

\section{New processing step: taxonomic refinement as a preprocessing step}
As an early step in the propinquity pipeline, we might want to try to reduce complexity of the
    decomposition by using the ranked source trees to
\begin{compactenum}
    \item place \insed groups more specifically (narrow the range of parental node sets) in the OTT hypergraph, and
    \item prune \insed groups from lower ranked trees if the same \insed group has been placed in a 
        conlicting position by a higher ranked tree.
\end{compactenum}

\section{Modified processing step: \insed-aware decomposition into subproblems}

\section{Modified processing step: \insed-aware assignment of taxonomic names}
For some named node, $n$, in \naiveFullTree, our current naive naming approach
    boils down to defining the include group to be all terminal OTT Ids that descend are assigned to descendants of $n$, and 
    the exclude group to be all other terminal OTT Ids.
If some tree has another node whose set of descendants are a subset of this include
    set are disjoint from this exclude group, then we give that node the name assigned to $n$.

An \insed-aware naming procedure is easiest to describe on the augmented tree, \augmentedFullTree.
For a named internal node $n$ on that tree, the include group is the set of terminal 
    OTT Ids (as before).
Let $\mathcal{Y}(n)$ denote the set of nodes that are ancestral to $n$.
Recall that $\insedChildren{x}$ is either the set of children or grandchildren of $x$ that 
    are flagged as being \insed (depending on whether $x\in\mathcal{A}$ or $x\notin\mathcal{A}$).
Let $$\mathcal{D}(n) =\bigcup_{i\in\mathcal{Y}(n)}\insedChildren{i}$$
in other words $\mathcal{D}(n)$ is the set of \insed children for any ansetor of $n$.
The are all of the \insed groups that, according to OTT, could be allowed to move into the named
    group.
So the exclude group for the named taxon $n$ becomes all terminal tips that are not:
\begin{compactitem}
    \item in the include set, OR
    \item descendants of any member of $\mathcal{D}(n)$ in \augmentedFullTree
\end{compactitem}
\section{Modified processing step: \insed-aware other annotations}
\bibliography{otcetera}
\end{document}
